#!/bin/bash -e

function usage() {
  echo "usage: $(basename $0) [-c|--config CONFIG] [-w|--workdir WORKDIR] CMDFILE" 1>&2
}

# Parse arguments
eval set -- "$(getopt -n "$0" -o "hvc:w:" -l "help,verbose,config:,workdir:" "--" "$@")"
if [ "$?" -ne 0 ]; then
  usage
  exit 1
fi

while true; do
  case "$1" in
    -h|--help) usage; exit 1; shift;;
    -v|--verbose) verbose=1; shift;;
    -c|--config) shift; CONFIG="${1}"; shift;;
    -w|--workdir) shift; WORKDIR="${1}"; shift;;
    --) shift; break;;
  esac
done

if [ -z "$1" ]; then
  echo "Missing CMDFILE"
  usage
  exit 1
fi

CONFIG=${CONFIG:-/etc/marketcetera/strategyagent.conf}
[ -r "$CONFIG" ] && . $CONFIG

METC_HOME="${METC_HOME:-/usr/share/marketcetera}"
SA_DIR="${SA_DIR:-$HOME/.strategyagent}"
if [ ! -f "$SA_DIR" ]; then
  mkdir -p $SA_DIR
  cp -r $METC_HOME/strategyagent/{conf,modules} $SA_DIR
fi

[ -r "$HOME/.strategyagent/strategyagent.conf" ] && . "$HOME/.strategyagent/strategyagent.conf"

# Determine classpath needed to run apps
CLASSPATH="${SA_DIR}/conf"
for jar in `ls -1 $METC_HOME/lib/*.jar`; do
  CLASSPATH=$CLASSPATH:$jar
done

USER_PROPERTIES_FILE="${SA_DIR}/conf/user.properties"
BIND_IP=${BIND_IP:-localhost}
ACTIVEMQ_PORT=${ACTIVEMQ_PORT:-61619}
WS_PORT=${WS_PORT:-9001}
ORS_HOST=${ORS_HOST:-localhost}
ORS_ACTIVEMQ_PORT=${ORS_ACTIVEMQ_PORT:-61618}
ORS_WS_PORT=${ORS_WS_PORT:-9000}

cat > $USER_PROPERTIES_FILE << EOF
metc.sa.ws.host=${BIND_IP}
metc.sa.ws.port=${WS_PORT}
metc.sa.recv.url=tcp://${BIND_IP}:${ACTIVEMQ_PORT}
metc.sa.client.URL=tcp://${ORS_HOST}:${ORS_ACTIVEMQ_PORT}
metc.sa.client.hostname=${ORS_HOST}
metc.sa.client.port=${ORS_WS_PORT}
EOF

WORKDIR=${WORKDIR:-`pwd`}
cd $WORKDIR
JAVA=`which java`
exec $JAVA -Xms384m -Xmx600m -XX:MaxPermSize=512m -server -Dorg.marketcetera.appDir=${SA_DIR} -cp $CLASSPATH org.marketcetera.strategyagent.StrategyAgent $* 2>&1
